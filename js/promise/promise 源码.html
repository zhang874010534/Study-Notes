<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style></style>
    <style></style>
  </head>
  <body>
    <script>
      //new Promiseçš„resolveå’Œrejectè¦åšçš„äº‹æƒ…å°±æ˜¯é€šè¿‡setTimeoutå®ä»»åŠ¡éåŽ†æ•°ç»„å¹¶è§¦å‘å‡½æ•°å°†å€¼ä¼ é€’ç»™å‡½æ•°

      // new promise çš„resolveå› ä¸ºè‚¯å®šæ˜¯pendingçŠ¶æ€è¦åšçš„å°±æ˜¯æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡å¾ªçŽ¯éåŽ†ä¸€ä¸ªæ•°ç»„å¹¶æ‰§è¡Œé‡Œé¢çš„å‡½æ•°å°†å€¼ä¼ ç»™è¿™ä¸ªå‡½æ•°
      //è¿™ä¸ªæ•°ç»„æ˜¯å­˜å‚¨ç€.thenæˆåŠŸçš„æ–¹æ³•,æ˜¯åœ¨.thençš„æ—¶å€™å­˜å…¥çš„ï¼Œ.thenä¹Ÿä¼šnewä¸€ä¸ªpromiseï¼Œç„¶åŽå°†è‡ªå·±ä¼ å…¥çš„å‡½æ•°åŒ…è£¹åœ¨ä¸€ä¸ªå‡½æ•°é‡Œå­˜å…¥æ•°ç»„ï¼Œç­‰å¾…resolveçš„å®ä»»åŠ¡æ¥æ‰§è¡Œ
      // ç¬¬ä¸€æ¬¡new Promise æ‰§è¡Œäº†rejectï¼Œrejectè¦åšçš„äº‹æƒ…å°±æ˜¯é€šè¿‡setTimeoutå®ä»»åŠ¡éåŽ†æ•°ç»„å¹¶è§¦å‘å‡½æ•°å°†å€¼ä¼ é€’ç»™å‡½æ•°(è¿™ä¸ªå‡½æ•°æ˜¯åŒ…è£¹ç€.thenä¼ å…¥çš„å‚æ•°)
      //ä»–åœ¨2æ¬¡.thenä¹‹åŽæ‰ä¼šæ‰§è¡Œ
      //ç¬¬ä¸€æ¬¡.thenå°†å‡½æ•°å­˜å…¥äº†ç¬¬ä¸€ä¸ªpromiseå®žä¾‹çš„æ•°ç»„ä¸­,ç¬¬äºŒæ¬¡.thenå°†å‡½æ•°å­˜å…¥äº†ç¬¬äºŒä¸ªpromiseå®žä¾‹çš„æ•°ç»„ä¸­
      //ç¬¬ä¸€æ¬¡çš„.thenä¼šæ‰§è¡Œreturn new promise å­˜å…¥çš„æ•°ç»„æ˜¯æœ€å¼€å§‹çš„resolveè§¦å‘çš„å®ä»»åŠ¡æ¥æ‰§è¡Œ
      //å¦‚æžœæœ‰è¿”å›žå€¼å¹¶ä¸”å¹¶ä¸æ˜¯promise é‚£ä¹ˆå°±æ‰§è¡Œä¸€ä¸ªresolve è¿™ä¸ªresolveæ˜¯ä¸ºäº†è§¦å‘ç¬¬äºŒä¸ª.thençš„resolveArræ•°ç»„
      class MyPromise {
        constructor(executor) {
          this.status = 'pending'; // åˆå§‹åŒ–çŠ¶æ€ä¸ºpending
          this.value = undefined; // åˆå§‹åŒ–è¿”å›žçš„æˆåŠŸçš„ç»“æžœæˆ–è€…å¤±è´¥çš„åŽŸå› 
          this.resolveArr = []; // åˆå§‹åŒ–thenä¸­æˆåŠŸçš„æ–¹æ³•
          this.rejectArr = []; // åˆå§‹åŒ–thenä¸­å¤±è´¥çš„æ–¹æ³•
          console.log(2);
          // å®šä¹‰changeæ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬å‘çŽ°å¥½åƒresolveå’Œrejectæ–¹æ³•å…±åŒçš„åœ°æ–¹è¿˜æŒºå¤šðŸ¤”
          let change = (status, value) => {
            if (this.status !== 'pending') return; // çŠ¶æ€ä¸€æ—¦æ”¹å˜ï¼Œå°±ä¸ä¼šå†å˜
            this.status = status;
            this.value = value;

            // æ ¹æ®çŠ¶æ€åˆ¤æ–­è¦æ‰§è¡ŒæˆåŠŸçš„æ–¹æ³•æˆ–å¤±è´¥çš„æ–¹æ³•
            let fnArr =
              status === 'resolved' ? this.resolveArr : this.rejectArr;
            console.log(fnArr[0]);
            // fnArrä¸­çš„æ–¹æ³•ä¾æ¬¡æ‰§è¡Œ
            fnArr.forEach((item) => {
              if (typeof item !== 'function') return;
              item(this.value);
            });
          };
          // è¿™é‡Œæ˜¯resolveæ–¹æ³•ï¼ŒæˆåŠŸåŽæ‰§è¡Œï¼Œå°†çŠ¶æ€æ”¹å˜ä¸ºresolvedï¼Œå¹¶ä¸”å°†ç»“æžœè¿”å›ž
          let resolve = (result) => {
            // å¦‚æžœæ•°ç»„ä¸­æœ‰å€¼ï¼Œåˆ™ç«‹å³æ”¹å˜çŠ¶æ€
            if (this.resolveArr.length > 0) {
              change('resolved', result);
            }
            // å¦‚æžœæ²¡å€¼ï¼Œåˆ™å»¶åŽæ”¹å˜çŠ¶æ€
            let timer = setTimeout((_) => {
              change('resolved', result);
              clearTimeout(timer);
            }, 0);
          };

          // è¿™é‡Œæ˜¯rejectæ–¹æ³•ï¼Œå¼‚å¸¸æ—¶æ‰§è¡Œï¼ŒçŠ¶æ€æ”¹ä¸ºrejectedï¼Œå¹¶ä¸”å°†å¤±è´¥çš„åŽŸå› è¿”å›ž
          let reject = (reason) => {
            // å¦‚æžœæ•°ç»„ä¸­æœ‰å€¼ï¼Œåˆ™ç«‹å³æ”¹å˜çŠ¶æ€
            if (this.rejectArr.length > 0) {
              change('rejected', reason);
            }
            // å¦‚æžœæ²¡å€¼ï¼Œåˆ™å»¶åŽæ”¹å˜çŠ¶æ€ åœ¨.thenéƒ½ç»“æŸäº†æ‰æ‰§è¡Œçš„
            let timer = setTimeout((_) => {
              change('rejected', reason);
              clearTimeout(timer);
            }, 0);
          };

          // tryã€catchæ•èŽ·å¼‚å¸¸ï¼Œå¦‚æžœé”™è¯¯ï¼Œæ‰§è¡Œrejectæ–¹æ³•
          try {
            executor(resolve, reject);
          } catch (err) {
            reject(err);
          }
        }

        then(resolveFn, rejectFn) {
          // å¦‚æžœä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œåˆ™ç›´æŽ¥æ‰§è¡Œè¿”å›žç»“æžœ

          if (typeof resolveFn !== 'function') {
            resolveFn = (result) => {
              return result;
            };
          }

          if (typeof rejectFn !== 'function') {
            rejectFn = (reason) => {
              return MyPromise.reject(reason);
            };
          }

          return new MyPromise((resolve, reject) => {
            console.log(1);
            this.resolveArr.push((result) => {
              try {
                let x = resolveFn(result); // èŽ·å–æ‰§è¡ŒæˆåŠŸæ–¹æ³•è¿”å›žçš„ç»“æžœ

                // å¦‚æžœxæ˜¯ä¸€ä¸ªpromiseå®žä¾‹ï¼Œåˆ™ç»§ç»­è°ƒç”¨thenæ–¹æ³• ==> thené“¾çš„å®žçŽ°
                if (x instanceof MyPromise) {
                  x.then(resolve, reject);
                  return;
                }

                // ä¸æ˜¯promiseå®žä¾‹ï¼Œç›´æŽ¥æ‰§è¡ŒæˆåŠŸçš„æ–¹æ³•
                resolve(x);
              } catch (err) {
                reject(err);
              }
            });

            this.rejectArr.push((reason) => {
              try {
                let x = rejectFn(reason);

                if (x instanceof MyPromise) {
                  x.then(resolve, reject);
                  return;
                }

                resolve(x);
              } catch (err) {
                reject(err);
              }
            });
          });
        }
      }

      // 3ã€é“¾å¼è°ƒç”¨
      // é¡ºåºå°±æ˜¯
      // new promise
      // .then new promise
      // .then new promise
      // rejectè§¦å‘ç¬¬ä¸€ä¸ª.thençš„æ•°ç»„(æ˜¯å­˜åœ¨ç¬¬ä¸€ä¸ªpromiseä¸Š) åˆæ‰§è¡Œäº†ä¸€ä¸ªresolve
      // resolveåˆè§¦å‘ç¬¬äºŒä¸ª.thençš„æ•°ç»„(æ˜¯å­˜åœ¨ç¬¬äºŒä¸ªpromiseä¸Šï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ª.thençš„promise)
      let a = new MyPromise((resolve, reject) => {
        reject('å¤±è´¥äº†ï¼Œæˆ‘å¥½å§”å±ˆï¼Œå‘œå‘œå‘œï½žï½ž'); //è®¾ç½®ä¸€ä¸ªå®ä»»åŠ¡ä¸ºäº†è§¦å‘å­˜å‚¨ç€.thenå‚æ•°(å‡½æ•°)çš„æ•°ç»„
        resolve('å·²ç»å¤±è´¥äº†ï½žï½žï½ž');
      })
        .then(
          //ä¼šnew ä¸€ä¸ªpromise å°†è‡ªå·±è¿™ä¸ªå‚æ•°å­˜å…¥ä¸€ä¸ªæ•°ç»„
          (res) => {
            console.log(res);
            return 'ç¬¬ä¸€ä¸ª.thençš„è¿”å›žå€¼';
          },
          (err) => {
            console.log(err, 'error'); // å¤±è´¥äº†ï¼Œæˆ‘å¥½å§”å±ˆï¼Œå‘œå‘œå‘œï½žï½ž error
            return 'æˆ‘è¦å‘å¥‹å›¾å¼ºï¼Œä¸ä¼šè¢«å›°éš¾æ‰€å‡»å€’ï¼Œæˆ‘è¦æˆåŠŸï¼ï¼ï¼';
          }
        )
        .then(
          (res1) => {
            console.log(res1, 'ç»è¿‡ä¸æ‡ˆåŠªåŠ›ï¼Œæˆ‘ç»ˆäºŽåœ¨ç¬¬äºŒæ¬¡æˆåŠŸäº†ï½ž'); // æˆ‘è¦å‘å¥‹å›¾å¼ºï¼Œä¸ä¼šè¢«å›°éš¾æ‰€å‡»å€’ï¼Œæˆ‘è¦æˆåŠŸï¼ï¼ï¼  ç»è¿‡ä¸æ‡ˆåŠªåŠ›ï¼Œæˆ‘ç»ˆäºŽåœ¨ç¬¬äºŒæ¬¡æˆåŠŸäº†ï½ž
          },
          (err1) => {
            console.log(err1, 'ç¬¬äºŒæ¬¡å¤±è´¥');
          }
        );
    </script>
  </body>
</html>
