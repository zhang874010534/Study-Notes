[「react进阶」一文吃透react事件系统原理](https://juejin.cn/post/6955636911214067720)

# 一 前言

今天我们来一起探讨一下`React`事件原理，这篇文章，我尽量用通俗简洁的方式，把`React`事件系统讲的明明白白。

我们讲的`react`版本是`16.13.1` , `v17`之后`react`对于事件系统会有相关的改版，文章后半部分会提及。

老规矩，在正式讲解`react`之前，我们先想想这几个问题(**如果我是面试官，你会怎么回答?**)：

- 1 我们写的事件是绑定在`dom`上么，如果不是绑定在哪里？
- 2 为什么我们的事件不能绑定给组件？
- 3 为什么我们的事件手动绑定`this`(不是箭头函数的情况)
- 4 为什么不能用 `return false `来阻止事件的默认行为？
- 5 `react`怎么通过`dom`元素，找到与之对应的 `fiber`对象的？
- 6 `onClick`是在冒泡阶段绑定的？ 那么`onClickCapture`就是在事件捕获阶段绑定的吗？

![B7836791-2C40-48BA-83BF-835E0BD87B55.jpg](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/46124c3589a1468aac72590d16f4787a~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

## 必要的知识概念

在弄清楚`react`事件之前，有几个概念我们必须弄清楚，因为只有弄明白这几个概念，在事件触发阶段，我们才能更好的理解`react`处理事件本质。

### 我们写在JSX事件终将变成什么？

我们先写一段含有点击事件的`react JSX`语法，看一下它最终会变成什么样子？

```js
class Index extends React.Component{
    handerClick= (value) => console.log(value) 
    render(){
        return <div>
            <button onClick={ this.handerClick } > 按钮点击 </button>
        </div>
    }
}
复制代码
```

经过`babel`转换成`React.createElement`形式，如下：

![babel.jpg](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/02eb66989a5444839c4e758b795869e7~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

最终转成`fiber`对象形式如下：

![fiber.jpg](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a2bd1a74076c40d1b5c5e7b53c341f7f~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

`fiber`对象上的`memoizedProps` 和 `pendingProps`保存了我们的事件。

### 什么是合成事件？

通过上一步我们看到了，我们声明事件保存的位置。但是事件有没有被真正的注册呢？我们接下来看一下：

我们看一下当前这个元素`<button>`上有没有绑定这个事件监听器呢？

![button_event.jpg](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fbd5b7c204754983b1eacc7bdcec8f88~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

**button上绑定的事件**

我们可以看到 ，`button`上绑定了两个事件，一个是`document`上的事件监听器，另外一个是`button`，但是事件处理函数`handle`，并不是我们的`handerClick`事件，而是`noop`。

`noop`是什么呢？我们接着来看。

原来`noop`就指向一个空函数。

![noop.jpg](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b419061b3c114309aeff3a59bd0d2f62~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

**然后我们看`document`绑定的事件**

![document.jpg](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b0df2ea775b24970aed90b79585da8a6~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

可以看到`click`事件被绑定在`document`上了。

接下来我们再搞搞事情😂😂😂，在`demo`项目中加上一个`input`输入框，并绑定一个`onChange`事件。睁大眼睛看看接下来会发生什么？

```js
class Index extends React.Component{
    componentDidMount(){
        console.log(this)
    }
    handerClick= (value) => console.log(value) 
    handerChange=(value) => console.log(value)
    render(){
        return <div style={{ marginTop:'50px' }} >
            <button onClick={ this.handerClick } > 按钮点击 </button>
            <input  placeholder="请输入内容" onChange={ this.handerChange }  />
        </div>
    }
}
复制代码
```

**我们先看一下`input dom`元素上绑定的事件**

![22BEC470-233A-4C50-9C47-D21D343C055D.jpg](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b7781dbc5af7455492f97903bdb2f54b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

**然后我们看一下`document`上绑定的事件**

![8E1D3BDB-ACFB-4E49-A5FF-CF990C47A60E.jpg](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2e956b39fff940bb919ac75aa4bd2cc3~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

我们发现，我们给`<input>`绑定的`onChange`，并没有直接绑定在`input`上，而是统一绑定在了`document`上，然后我们`onChange`被处理成很多事件监听器，比如`blur` , `change` , `input` , `keydown` , `keyup` 等。

综上我们可以得出结论：

- ①**我们在 `jsx` 中绑定的事件(demo中的`handerClick`，`handerChange`),根本就没有注册到真实的`dom`上。是绑定在`document`上统一管理的。**
- ②**真实的`dom`上的`click`事件被单独处理,已经被`react`底层替换成空函数。**
- ③**我们在`react`绑定的事件,比如`onChange`，在`document`上，可能有多个事件与之对应。**
- ④ **`react`并不是一开始，把所有的事件都绑定在`document`上，而是采取了一种按需绑定，比如发现了`onClick`事件,再去绑定`document click`事件。**

那么什么是`react`事件合成呢？

**在`react`中，我们绑定的事件`onClick`等，并不是原生事件，而是由原生事件合成的`React`事件，比如 `click`事件合成为`onClick`事件。比如`blur` , `change` , `input` , `keydown` , `keyup`等 , 合成为`onChange`。**

那么`react`采取这种事件合成的模式呢？

一方面，将事件绑定在`document`统一管理，防止很多事件直接绑定在原生的`dom`元素上。造成一些不可控的情况

另一方面， `React` 想实现一个全浏览器的框架， 为了实现这种目标就需要提供全浏览器一致性的事件系统，以此抹平不同浏览器的差异。

接下来的文章中，会介绍`react`是怎么做事件合成的。

### dom元素对应的fiber Tag对象

我们知道了`react`怎么储存了我们的事件函数和事件合成因果。接下来我想让大家记住一种类型的 `fiber` 对象,因为后面会用到，这对后续的理解很有帮助。

我们先来看一个代码片段：

```js
<div> 
  <div> hello , my name is alien </div>
</div>
复制代码
```

看` <div> hello , my name is alien </div>` 对应的 `fiber`类型。 tag = 5

![B7514E02-E542-4BDC-8CF3-F198D094A9D3.jpg](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/705f5e85f9db452b9881b1f7c6878662~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp) 然后我们去`react`源码中找到这种类的`fiber`类型。

> /react-reconciler/src/ReactWorkTagsq.js

```js
export const HostComponent = 5; // 元素节点

复制代码
```

好的 ，我们暂且把 `HostComponent` 和 `HostText`记录📝下来。接下来回归正题，我们先来看看`react`事件合成机制。
